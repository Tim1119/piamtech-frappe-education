var Q=Object.defineProperty,W=Object.defineProperties;var Z=Object.getOwnPropertyDescriptors;var z=Object.getOwnPropertySymbols;var ee=Object.prototype.hasOwnProperty,te=Object.prototype.propertyIsEnumerable;var T=(c,m,l)=>m in c?Q(c,m,{enumerable:!0,configurable:!0,writable:!0,value:l}):c[m]=l,q=(c,m)=>{for(var l in m||(m={}))ee.call(m,l)&&T(c,l,m[l]);if(z)for(var l of z(m))te.call(m,l)&&T(c,l,m[l]);return c},L=(c,m)=>W(c,Z(m));var j=(c,m,l)=>new Promise((h,y)=>{var b=u=>{try{f(l.next(u))}catch(v){y(v)}},_=u=>{try{f(l.throw(u))}catch(v){y(v)}},f=u=>u.done?h(u.value):Promise.resolve(u.value).then(b,_);f((l=l.apply(c,m)).next())});import{r as P,f as K,s as n,v as d,y as g,z as C,x as e,F as p,D as i,a5 as X,E as B,a6 as S,B as x,a7 as U,K as $,X as F,N as se,a8 as O,a9 as ae,l as oe,L as Y,aa as ne,I as G,J,a4 as le,ab as ie,ac as re,ad as de}from"./frappe-ui.97769d2e.js";import{c as w}from"./index.8ac83f96.js";import{s as ce}from"./index.701b120f.js";const ue={class:"flex flex-col gap-4"},me={class:"bg-gray-50 border rounded-lg p-4"},_e=e("h3",{class:"text-sm font-semibold text-gray-900 mb-4"},"Complete Fee Breakdown",-1),ye={class:"space-y-3 text-sm"},pe={class:"flex justify-between items-center"},ge=e("span",{class:"text-gray-600"},"Original Invoice Amount:",-1),be={class:"font-semibold text-gray-900 text-base"},fe={class:"border-t pt-3"},he=e("p",{class:"text-gray-600 mb-2 font-medium"},"Payments Made:",-1),ve={class:"pl-4 space-y-1"},xe={class:"flex justify-between"},we=e("span",{class:"text-gray-600"},"Total Paid:",-1),ke={class:"font-semibold text-green-600"},Pe={class:"border-t pt-3 bg-red-50 p-3 rounded"},$e={class:"flex justify-between"},Ce=e("span",{class:"text-gray-700 font-medium"},"Outstanding Balance:",-1),Fe={class:"font-semibold text-red-600 text-base"},Ve={class:"border-t pt-4"},Ne=e("h3",{class:"text-sm font-semibold text-gray-900 mb-3"},"Invoice Details",-1),Ae={class:"space-y-2 text-sm"},De={class:"flex justify-between"},je=e("span",{class:"text-gray-600"},"Student:",-1),Ee={class:"font-semibold"},Ie={class:"flex justify-between"},Se=e("span",{class:"text-gray-600"},"Student ID:",-1),Ue={class:"font-semibold"},Be={class:"flex justify-between"},Oe=e("span",{class:"text-gray-600"},"Program:",-1),Re={class:"font-semibold"},Me={class:"flex justify-between"},ze=e("span",{class:"text-gray-600"},"Invoice:",-1),Te={class:"font-semibold text-blue-600"},qe={class:"flex justify-between"},Le=e("span",{class:"text-gray-600"},"Status:",-1),Ye={class:"border-t pt-4"},Ge=e("h3",{class:"text-sm font-semibold text-gray-900 mb-3"},"Payment Type",-1),Je={class:"grid grid-cols-2 gap-3"},Ke={key:0,class:"border-t pt-4"},Xe=e("h3",{class:"text-sm font-semibold text-gray-900 mb-4"},"Amount to Pay",-1),He=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"}," Enter Amount * ",-1),Qe={class:"relative"},We=e("span",{class:"absolute left-3 top-3 text-gray-600"},"\u20A6",-1),Ze={class:"mt-3 p-3 bg-gray-50 rounded text-sm space-y-2"},et={class:"flex justify-between"},tt=e("span",{class:"text-gray-600"},"Outstanding Balance:",-1),st={class:"font-semibold text-gray-900"},at={class:"flex justify-between"},ot=e("span",{class:"text-gray-600"},"You are paying:",-1),nt={class:"font-semibold text-gray-900"},lt={key:0,class:"flex justify-between border-t pt-2"},it=e("span",{class:"text-gray-600"},"Balance after payment:",-1),rt={class:"font-semibold text-gray-900"},dt={key:1,class:"border-t pt-4 bg-gray-50 p-3 rounded"},ct=e("p",{class:"text-sm text-gray-600 mb-2"},"You will pay the full outstanding:",-1),ut={class:"font-semibold text-lg text-gray-900"},mt={class:"border-t pt-4"},_t=e("h3",{class:"text-sm font-semibold text-gray-900 mb-4"},"Contact Information",-1),yt={class:"grid grid-cols-2 gap-4"},pt=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Email Address *",-1),gt=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"},"Phone Number *",-1),bt={key:2,class:"flex items-center justify-center py-4"},ft=e("div",{class:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"},null,-1),ht=e("span",{class:"ml-2 text-gray-600"},"Processing payment...",-1),vt=[ft,ht],xt=e("div",{class:"bg-green-50 border border-green-200 rounded p-3"},[e("p",{class:"text-sm text-green-800"}," \u2713 You will be securely redirected to Paystack to complete your payment. ")],-1),wt={class:"flex flex-row-reverse gap-2"},kt={__name:"FeesPaymentDialog",props:{modelValue:{type:Boolean,required:!1},student:{type:Object,required:!0},row:{type:Object,required:!0}},emits:["update:modelValue","success"],setup(c,{emit:m}){const l=c,h=m,y=P(!1),b=P("Full"),_=P(null),f=P(""),u=K({email:l.student.student_email_id||l.student.email||"",mobile_number:l.student.phone||""}),v=()=>l.row.original_amount||l.row.amount||"\u20A60.00",E=()=>l.row.amount_paid||"\u20A60.00",V=()=>l.row.amount_outstanding||"\u20A60.00",I=()=>{const t=parseFloat(l.row.amount_outstanding_raw)||0,s=_.value||0,o=t-s;return N(o>0?o:0)},N=t=>new Intl.NumberFormat("en-NG",{style:"currency",currency:"NGN"}).format(t),A=()=>{f.value="";const t=parseFloat(l.row.amount_outstanding_raw)||0;return!_.value||_.value<=0?(f.value="Amount must be greater than zero",!1):_.value>t?(f.value=`Amount cannot exceed outstanding balance (${N(t)})`,!1):!0},D=()=>b.value==="Full"?u.email&&u.mobile_number:u.email&&u.mobile_number&&_.value&&_.value>0&&A(),a=t=>({Paid:"green",Unpaid:"red",Overdue:"red","Partly Paid":"orange"})[t],r=()=>j(this,null,function*(){if(!D()){w({title:"Validation Error",description:"Please fill in all required fields correctly",icon:"alert-circle",iconClasses:"text-red-600"});return}y.value=!0;try{const t=parseFloat(l.row.amount_outstanding_raw)||0,s=b.value==="Full"?t:_.value,o=yield O("piamtech_frappe_education.paystack.initiate_payment",{sales_invoice:l.row.invoice,payment_amount:s,email:u.email});o.success?window.location.href=o.authorization_url:(w({title:"Payment Error",description:o.message||"Failed to initiate payment",icon:"x",iconClasses:"text-red-600"}),y.value=!1)}catch(t){console.error("Payment error:",t),w({title:"Error",description:t.message||"Failed to process payment",icon:"x",iconClasses:"text-red-600"}),y.value=!1}});return(t,s)=>(n(),d("div",null,[g(i(se),{options:{title:"Pay Invoice",actions:[{label:"Proceed",variant:"solid"}]},modelValue:c.modelValue,"onUpdate:modelValue":s[6]||(s[6]=o=>h("update:modelValue",o))},{"body-content":C(()=>[e("div",ue,[e("div",me,[_e,e("div",ye,[e("div",pe,[ge,e("span",be,p(v()),1)]),e("div",fe,[he,e("div",ve,[e("div",xe,[we,e("span",ke,p(E()),1)])])]),e("div",Pe,[e("div",$e,[Ce,e("span",Fe,p(V()),1)])])])]),e("div",Ve,[Ne,e("div",Ae,[e("div",De,[je,e("span",Ee,p(c.student.student_name),1)]),e("div",Ie,[Se,e("span",Ue,p(c.student.name),1)]),e("div",Be,[Oe,e("span",Re,p(c.row.program),1)]),e("div",Me,[ze,e("span",Te,p(c.row.invoice),1)]),e("div",qe,[Le,g(i(X),{variant:"subtle",theme:a(c.row.status),size:"sm",label:c.row.status},null,8,["theme","label"])])])]),e("div",Ye,[Ge,e("div",Je,[e("button",{onClick:s[0]||(s[0]=o=>b.value="Full"),class:B(["p-3 rounded-lg border-2 transition-colors text-sm font-medium",b.value==="Full"?"border-blue-600 bg-blue-50 text-blue-900":"border-gray-200 bg-white text-gray-700 hover:border-gray-300"])}," Full Payment ",2),e("button",{onClick:s[1]||(s[1]=o=>b.value="Partial"),class:B(["p-3 rounded-lg border-2 transition-colors text-sm font-medium",b.value==="Partial"?"border-blue-600 bg-blue-50 text-blue-900":"border-gray-200 bg-white text-gray-700 hover:border-gray-300"])}," Partial Payment ",2)])]),b.value==="Partial"?(n(),d("div",Ke,[Xe,e("div",null,[He,e("div",Qe,[We,g(i(S),{type:"number",modelValue:_.value,"onUpdate:modelValue":s[2]||(s[2]=o=>_.value=o),modelModifiers:{number:!0},placeholder:"0.00",class:"pl-8",step:"0.01",onChange:A},null,8,["modelValue"])]),f.value?(n(),x(i(U),{key:0,message:f.value,class:"pt-2"},null,8,["message"])):$("",!0),e("div",Ze,[e("div",et,[tt,e("span",st,p(V()),1)]),e("div",at,[ot,e("span",nt,p(_.value?N(_.value):"\u20A60.00"),1)]),_.value?(n(),d("div",lt,[it,e("span",rt,p(I()),1)])):$("",!0)])])])):(n(),d("div",dt,[ct,e("p",ut,p(V()),1)])),e("div",mt,[_t,e("div",yt,[e("div",null,[pt,g(i(S),{type:"email",modelValue:u.email,"onUpdate:modelValue":s[3]||(s[3]=o=>u.email=o),placeholder:"your@email.com"},null,8,["modelValue"]),u.email?$("",!0):(n(),x(i(U),{key:0,message:"Email is required",class:"pt-2"}))]),e("div",null,[gt,g(i(S),{type:"tel",modelValue:u.mobile_number,"onUpdate:modelValue":s[4]||(s[4]=o=>u.mobile_number=o),placeholder:"+234 800 000 0000"},null,8,["modelValue"]),u.mobile_number?$("",!0):(n(),x(i(U),{key:0,message:"Phone number is required",class:"pt-2"}))])])]),y.value?(n(),d("div",bt,vt)):$("",!0),xt])]),actions:C(({close:o})=>[e("div",wt,[g(i(F),{class:"h-9",variant:"solid",onClick:s[5]||(s[5]=k=>r()),"icon-left":"external-link",loading:y.value,label:"Proceed to Payment",disabled:!D()||y.value},null,8,["loading","disabled"]),g(i(F),{class:"h-9",variant:"outline",onClick:o,label:"Cancel",disabled:y.value},null,8,["onClick","disabled"])])]),_:1},8,["modelValue"])]))}},Pt={class:"min-h-screen bg-gray-50"},$t=e("div",{class:"bg-white border-b px-6 py-4"},[e("h1",{class:"text-2xl font-bold text-gray-900"},"My Fees"),e("p",{class:"text-gray-600 mt-1"},"View and pay your school fees")],-1),Ct={class:"p-6"},Ft={key:0,class:"text-center py-12"},Vt=e("div",{class:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"},null,-1),Nt=e("p",{class:"text-gray-600"},"Loading your fees...",-1),At=[Vt,Nt],Dt={key:1,class:"bg-red-50 border border-red-200 rounded-lg p-6 mb-6"},jt={class:"flex items-start"},Et=e("h3",{class:"text-sm font-medium text-red-800"},"Error Loading Fees",-1),It={class:"text-sm text-red-700 mt-1"},St={key:2,class:"bg-white rounded-lg border shadow-sm overflow-hidden"},Ut={key:1,class:"text-gray-900 font-medium"},Bt={key:2,class:"font-semibold text-gray-900"},Ot={key:3,class:"text-green-600 font-semibold"},Rt={key:5,class:"text-gray-700"},Mt={key:6,class:"flex justify-center"},zt={key:7,class:"flex justify-center"},Tt={key:1,class:"text-gray-400 text-xs"},qt={key:8,class:"flex justify-center"},Lt={key:1,class:"text-green-600 text-xs font-semibold"},Yt={key:3,class:"bg-white rounded-lg border p-12 text-center"},Gt=e("h3",{class:"text-lg font-medium text-gray-900 mb-2"},"No Fees Found",-1),Jt=e("p",{class:"text-gray-600"},"You don't have any fees at the moment.",-1),Wt={__name:"Fees",setup(c){const{getStudentInfo:m}=ce(),l=P(m().value);ae(()=>{const a=new URLSearchParams(window.location.search);if(a.has("success")&&(w({title:"Payment Successful! \u{1F389}",description:"Your payment has been processed. Fees updated.",icon:"check",iconClasses:"text-green-600"}),setTimeout(()=>{h.reload(),window.history.replaceState({},document.title,"/student-portal/fees")},1e3)),a.has("error")){const r=a.get("error");w({title:"Payment Error",description:{verification_failed:"Payment verification failed. Please contact support.",payment_processing_failed:"Error processing your payment. Please try again.",payment_failed:"Payment was declined. Please try again.",verification_error:"An error occurred during verification. Please try again."}[r]||"An error occurred during payment.",icon:"x",iconClasses:"text-red-600"}),window.history.replaceState({},document.title,"/student-portal/fees")}});const h=oe({url:"piamtech_frappe_education.school_portal_api.get_student_invoices_with_details",params:{student:l.value.name},onSuccess:a=>{let r=(a==null?void 0:a.invoices)||[];r=r.map(t=>{const s=t.original_amount||0,o=t.total_paid||0,k=t.outstanding_amount||0;return L(q({},t),{original_amount:v(s),original_amount_raw:s,amount_paid:v(o),amount_paid_raw:o,amount_outstanding:v(k),amount_outstanding_raw:k})}),r=r.sort((t,s)=>{var R,M;const o={Overdue:0,Unpaid:1,"Partly Paid":2,Paid:3},k=(R=o[t.status])!=null?R:99,H=(M=o[s.status])!=null?M:99;return k-H}),y.rows=r,f.value=(a==null?void 0:a.print_format)||"Standard"},onError:a=>{w({title:"Error loading fees",icon:"x",iconClasses:"text-red-600"})},auto:!0}),y=K({rows:[],columns:[{label:"Program",key:"program",width:1},{label:"Status",key:"status",width:1},{label:"Original Amount",key:"original_amount",width:1},{label:"Amount Paid",key:"amount_paid",width:1},{label:"Outstanding",key:"amount_outstanding",width:1},{label:"Due Date",key:"due_date",width:1},{label:"Download Bill",key:"download_bill",width:1},{label:"Download Receipt",key:"download_receipt",width:1},{label:"Pay Now",key:"pay_now",width:1}]}),b=P(null),_=P(!1),f=P("Standard"),u=a=>!a||a==="-"?"-":new Date(a).toLocaleDateString("en-NG",{year:"numeric",month:"short",day:"numeric"}),v=a=>new Intl.NumberFormat("en-NG",{style:"currency",currency:"NGN"}).format(a),E=a=>({Paid:"green",Unpaid:"red",Overdue:"red","Partly Paid":"orange"})[a],V=a=>a===0?"text-green-600 font-semibold":a>0?"text-red-600 font-semibold":"text-gray-700",I=a=>j(this,null,function*(){try{const r=yield O("piamtech_frappe_education.school_portal_api.get_print_format_for_fees",{program:a.program,format_type:"bill"}),t=`/printview?doctype=Sales%20Invoice&name=${encodeURIComponent(a.invoice)}&format=${encodeURIComponent(r)}&no_letterhead=1`;window.open(t,"_blank")}catch(r){w({title:"Error",description:"Failed to open bill",icon:"x",iconClasses:"text-red-600"})}}),N=a=>j(this,null,function*(){try{const r=yield O("piamtech_frappe_education.school_portal_api.get_print_format_for_fees",{program:a.program,format_type:"receipt"}),t=`/printview?doctype=Sales%20Invoice&name=${encodeURIComponent(a.invoice)}&format=${encodeURIComponent(r)}&no_letterhead=1`;window.open(t,"_blank")}catch(r){w({title:"Error",description:"Failed to open receipt",icon:"x",iconClasses:"text-red-600"})}}),A=a=>{b.value=a,_.value=!0},D=()=>{h.reload(),w({title:"Payment successful!",description:"Your payment has been processed",icon:"check",iconClasses:"text-green-600"})};return(a,r)=>(n(),d("div",Pt,[$t,e("div",Ct,[i(h).loading?(n(),d("div",Ft,At)):i(h).error?(n(),d("div",Dt,[e("div",jt,[g(i(Y),{name:"alert-circle",class:"h-5 w-5 text-red-600 mt-0.5 mr-3"}),e("div",null,[Et,e("p",It,p(i(h).error),1),g(i(F),{onClick:r[0]||(r[0]=t=>i(h).reload()),variant:"outline",size:"sm",class:"mt-3",label:"Try Again"})])])])):y.rows.length>0?(n(),d("div",St,[g(i(le),{columns:y.columns,rows:y.rows,options:{selectable:!1,showTooltip:!1,onRowClick:()=>{}},"row-key":"invoice"},{default:C(()=>[g(i(ne),null,{default:C(()=>[(n(!0),d(G,null,J(y.columns,t=>(n(),x(i(ie),{key:t.key,item:t},null,8,["item"]))),128))]),_:1}),(n(!0),d(G,null,J(y.rows,t=>(n(),x(i(re),{key:t.invoice,row:t},{default:C(({column:s,item:o})=>[g(i(de),{item:o,align:s.align},{default:C(()=>[s.key==="status"?(n(),x(i(X),{key:0,variant:"subtle",theme:E(t.status),size:"md",label:o},null,8,["theme","label"])):s.key==="program"?(n(),d("span",Ut,p(o),1)):s.key==="original_amount"?(n(),d("span",Bt,p(o),1)):s.key==="amount_paid"?(n(),d("span",Ot,p(o),1)):s.key==="amount_outstanding"?(n(),d("span",{key:4,class:B(V(t.amount_outstanding_raw))},p(o),3)):s.key==="due_date"?(n(),d("span",Rt,p(o==="-"?"N/A":u(o)),1)):s.key==="download_bill"?(n(),d("div",Mt,[g(i(F),{onClick:k=>I(t),variant:"outline",size:"sm","icon-left":"download",label:"Bill",title:"Download invoice to see what you're paying for"},null,8,["onClick"])])):s.key==="download_receipt"?(n(),d("div",zt,[t.status==="Paid"||t.status==="Partly Paid"?(n(),x(i(F),{key:0,onClick:k=>N(t),variant:"outline",size:"sm","icon-left":"file-text",label:"Receipt",title:"Download payment receipt with payment history"},null,8,["onClick"])):(n(),d("span",Tt,"Not available"))])):s.key==="pay_now"?(n(),d("div",qt,[t.status!=="Paid"?(n(),x(i(F),{key:0,onClick:k=>A(t),variant:"solid",size:"sm","icon-left":"credit-card",label:"Pay Now"},null,8,["onClick"])):(n(),d("span",Lt,"\u2713 Paid"))])):$("",!0)]),_:2},1032,["item","align"])]),_:2},1032,["row"]))),128))]),_:1},8,["columns","rows"])])):(n(),d("div",Yt,[g(i(Y),{name:"inbox",class:"h-12 w-12 text-gray-400 mx-auto mb-4"}),Gt,Jt]))]),b.value?(n(),x(kt,{key:0,row:b.value,student:l.value,modelValue:_.value,"onUpdate:modelValue":r[1]||(r[1]=t=>_.value=t),onSuccess:r[2]||(r[2]=t=>D())},null,8,["row","student","modelValue"])):$("",!0)]))}};export{Wt as default};
